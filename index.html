<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Granja TRX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #e60000;
            --primary-dark: #b30000;
            --secondary: #ffcc00;
            --dark: #1a1a1a;
            --light: #f5f5f5;
            --gray: #888;
            --success: #00cc66;
            --warning: #ff9900;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #1a1a1a;
            color: var(--light);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #222;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: var(--secondary);
            font-size: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #222;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
            color: var(--secondary);
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .dashboard-section {
            background: #222;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: #2a2a2a;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
            color: var(--light);
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            background-color: #2a2a2a;
            color: var(--secondary);
        }
        
        tr:hover {
            background-color: #2a2a2a;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-sm {
            padding: 5px 8px;
            font-size: 0.8rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #00b359;
        }
        
        .btn-danger {
            background: #ff3333;
            color: white;
        }
        
        .btn-danger:hover {
            background: #cc0000;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e68a00;
        }
        
        .btn-info {
            background: #0099ff;
            color: white;
        }
        
        .btn-info:hover {
            background: #0077cc;
        }
        
        .alert {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .alert-success {
            background: rgba(0, 204, 102, 0.2);
            color: #00cc66;
            border: 1px solid #00cc66;
        }
        
        .alert-error {
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
            border: 1px solid #ff3333;
        }
        
        .alert-warning {
            background: rgba(255, 153, 0, 0.2);
            color: #ff9900;
            border: 1px solid #ff9900;
        }
        
        .alert-info {
            background: rgba(0, 153, 255, 0.2);
            color: #0099ff;
            border: 1px solid #0099ff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending {
            background: rgba(255, 153, 0, 0.2);
            color: var(--warning);
        }
        
        .status-approved {
            background: rgba(0, 204, 102, 0.2);
            color: var(--success);
        }
        
        .status-rejected {
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
        }
        
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 4px;
            color: var(--light);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: #222;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 1px solid #333;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--secondary);
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
            color: var(--light);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--primary);
        }
        
        .toast.warning {
            background: var(--warning);
        }
        
        .toast.info {
            background: #0099ff;
        }
        
        .toast i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        .referrals-list {
            max-height: 200px;
            overflow-y: auto;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .referral-item {
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        
        .referral-item:last-child {
            border-bottom: none;
        }
        
        .animals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .animal-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .animal-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .animal-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .animal-level {
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .animal-actions {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        
        .animal-type-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .animal-type {
            padding: 10px;
            text-align: center;
            background: #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .animal-type.selected {
            background: var(--primary);
            color: white;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .animal-type-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cogs"></i> Panel de Administración - Granja TRX</h1>
            <div id="last-update">Última actualización: --:--:--</div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Usuarios</div>
                <div class="stat-value" id="total-users">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Depósitos Pendientes</div>
                <div class="stat-value" id="pending-deposits">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Retiros Pendientes</div>
                <div class="stat-value" id="pending-withdrawals">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">TRX en Sistema</div>
                <div class="stat-value" id="total-trx">0.00</div>
            </div>
        </div>
        
        <div class="dashboard-section">
            <div class="tabs">
                <button class="tab active" data-tab="deposits">Depósitos</button>
                <button class="tab" data-tab="withdrawals">Retiros</button>
                <button class="tab" data-tab="users">Usuarios</button>
                <button class="tab" data-tab="animals">Animales</button>
            </div>
            
            <!-- Pestaña de Depósitos -->
            <div class="tab-content active" id="deposits-tab">
                <div class="search-container">
                    <input type="text" id="deposit-search" class="search-input" placeholder="Buscar por email, hash o ID...">
                    <select id="deposit-filter">
                        <option value="all">Todos</option>
                        <option value="pending">Pendientes</option>
                        <option value="approved">Aprobados</option>
                        <option value="rejected">Rechazados</option>
                    </select>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Cantidad</th>
                            <th>Hash</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="deposits-table">
                        <!-- Los depósitos se cargarán aquí -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pestaña de Retiros -->
            <div class="tab-content" id="withdrawals-tab">
                <div class="search-container">
                    <input type="text" id="withdrawal-search" class="search-input" placeholder="Buscar por email, dirección o ID...">
                    <select id="withdrawal-filter">
                        <option value="all">Todos</option>
                        <option value="pending">Pendientes</option>
                        <option value="approved">Aprobados</option>
                        <option value="rejected">Rechazados</option>
                    </select>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Cantidad</th>
                            <th>Dirección</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table">
                        <!-- Los retiros se cargarán aquí -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pestaña de Usuarios -->
            <div class="tab-content" id="users-tab">
                <div class="search-container">
                    <input type="text" id="user-search" class="search-input" placeholder="Buscar por email o ID...">
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Balance</th>
                            <th>Animales</th>
                            <th>Referidos</th>
                            <th>Fecha Registro</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <!-- Los usuarios se cargarán aquí -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pestaña de Animales -->
            <div class="tab-content" id="animals-tab">
                <div class="search-container">
                    <input type="text" id="animal-search" class="search-input" placeholder="Buscar usuario por email...">
                    <button class="btn btn-primary" onclick="filterAnimals()">Buscar</button>
                </div>
                
                <div id="animals-container">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Busca un usuario para ver y gestionar sus animales.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para aprobar/rechazar depósito -->
    <div id="deposit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Gestionar Depósito</h2>
                <span class="close" onclick="closeModal('deposit-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="modal-deposit-user" readonly>
                </div>
                <div class="form-group">
                    <label>Cantidad (TRX)</label>
                    <input type="text" id="modal-deposit-amount" readonly>
                </div>
                <div class="form-group">
                    <label>Hash de Transacción</label>
                    <input type="text" id="modal-deposit-hash" readonly>
                </div>
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="text" id="modal-deposit-date" readonly>
                </div>
                <div class="form-group">
                    <label>Estado Actual</label>
                    <input type="text" id="modal-deposit-status" readonly>
                </div>
                <div class="form-group">
                    <label for="deposit-action">Acción</label>
                    <select id="deposit-action">
                        <option value="approve">Aprobar Depósito</option>
                        <option value="reject">Rechazar Depósito</option>
                        <option value="delete">Eliminar Depósito</option>
                    </select>
                </div>
                <div class="form-group" id="reject-reason-container" style="display: none;">
                    <label for="reject-reason">Motivo de Rechazo</label>
                    <textarea id="reject-reason" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="process-deposit-btn" onclick="processDeposit()">Procesar</button>
                <button class="btn btn-danger" onclick="closeModal('deposit-modal')">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para aprobar/rechazar retiro -->
    <div id="withdrawal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Gestionar Retiro</h2>
                <span class="close" onclick="closeModal('withdrawal-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="modal-withdrawal-user" readonly>
                </div>
                <div class="form-group">
                    <label>Cantidad (TRX)</label>
                    <input type="text" id="modal-withdrawal-amount" readonly>
                </div>
                <div class="form-group">
                    <label>Dirección TRX</label>
                    <input type="text" id="modal-withdrawal-address" readonly>
                </div>
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="text" id="modal-withdrawal-date" readonly>
                </div>
                <div class="form-group">
                    <label>Estado Actual</label>
                    <input type="text" id="modal-withdrawal-status" readonly>
                </div>
                <div class="form-group">
                    <label for="withdrawal-action">Acción</label>
                    <select id="withdrawal-action">
                        <option value="approve">Aprobar Retiro</option>
                        <option value="reject">Rechazar Retiro</option>
                        <option value="delete">Eliminar Retiro</option>
                    </select>
                </div>
                <div class="form-group" id="withdrawal-reject-reason-container" style="display: none;">
                    <label for="withdrawal-reject-reason">Motivo de Rechazo</label>
                    <textarea id="withdrawal-reject-reason" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="process-withdrawal-btn" onclick="processWithdrawal()">Procesar</button>
                <button class="btn btn-danger" onclick="closeModal('withdrawal-modal')">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para editar usuario -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Usuario</h2>
                <span class="close" onclick="closeModal('user-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ID de Usuario</label>
                    <input type="text" id="modal-user-id" readonly>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="text" id="modal-user-email" readonly>
                </div>
                <div class="form-group">
                    <label for="modal-user-balance">Balance (TRX)</label>
                    <input type="number" id="modal-user-balance" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="modal-user-status">Estado de Cuenta</label>
                    <select id="modal-user-status">
                        <option value="active">Activa</option>
                        <option value="suspended">Suspendida</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="update-user-btn" onclick="updateUser()">Actualizar</button>
                <button class="btn btn-danger" id="delete-user-btn" onclick="deleteUser()">Eliminar Usuario</button>
                <button class="btn btn-danger" onclick="closeModal('user-modal')">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para ver referidos -->
    <div id="referrals-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Referidos del Usuario</h2>
                <span class="close" onclick="closeModal('referrals-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="modal-referrals-user" readonly>
                </div>
                <div class="form-group">
                    <label>Total de Referidos</label>
                    <input type="text" id="modal-referrals-count" readonly>
                </div>
                <div class="form-group">
                    <label>Lista de Referidos</label>
                    <div class="referrals-list" id="referrals-list">
                        <!-- Los referidos se cargarán aquí -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('referrals-modal')">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para gestionar animales -->
    <div id="animals-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Gestionar Animales</h2>
                <span class="close" onclick="closeModal('animals-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="modal-animals-user" readonly>
                </div>
                <div class="form-group">
                    <label>Total de Animales</label>
                    <input type="text" id="modal-animals-count" readonly>
                </div>
                
                <h3 style="margin: 15px 0; color: var(--secondary);">Añadir Nuevo Animal</h3>
                <div class="animal-type-selector" id="animal-type-selector">
                    <div class="animal-type" data-type="vaca">
                        <i class="fas fa-cow"></i>
                        <div>Vaca</div>
                    </div>
                    <div class="animal-type" data-type="gallina">
                        <i class="fas fa-kiwi-bird"></i>
                        <div>Gallina</div>
                    </div>
                    <div class="animal-type" data-type="cerdo">
                        <i class="fas fa-piggy-bank"></i>
                        <div>Cerdo</div>
                    </div>
                    <div class="animal-type" data-type="oveja">
                        <i class="fas fa-cloud"></i>
                        <div>Oveja</div>
                    </div>
                    <div class="animal-type" data-type="caballo">
                        <i class="fas fa-horse"></i>
                        <div>Caballo</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="animal-level">Nivel del Animal</label>
                    <select id="animal-level">
                        <option value="1">Nivel 1</option>
                        <option value="2">Nivel 2</option>
                        <option value="3">Nivel 3</option>
                        <option value="4">Nivel 4</option>
                        <option value="5">Nivel 5</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="addAnimal()">Añadir Animal</button>
                
                <h3 style="margin: 20px 0 10px; color: var(--secondary);">Animales Actuales</h3>
                <div class="animals-grid" id="modal-animals-list">
                    <!-- Los animales se cargarán aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('animals-modal')">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Operación realizada con éxito</span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Configuración de Firebase (la misma que en user.html)
        const firebaseConfig = {
            apiKey: "AIzaSyDiIz3QpI1rYEyMYP512tdKM7pkzWFSFKg",
            authDomain: "mina-trx.firebaseapp.com",
            databaseURL: "https://mina-trx-default-rtdb.firebaseio.com",
            projectId: "mina-trx",
            storageBucket: "mina-trx.firebasestorage.app",
            messagingSenderId: "592300655333",
            appId: "1:592300655333:web:a5fff60b36c9a880114a0c",
            measurementId: "G-GREBM8YM08"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Variables globales
        let allUsers = [];
        let allDeposits = [];
        let allWithdrawals = [];
        let currentEditingDeposit = null;
        let currentEditingWithdrawal = null;
        let currentEditingUser = null;
        let currentAnimalUser = null;
        let selectedAnimalType = null;
        
        // Inicializar la aplicación
        function initApp() {
            // Cargar datos iniciales
            loadAllData();
            
            // Configurar pestañas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Desactivar todas las pestañas
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Activar la pestaña seleccionada
                    this.classList.add('active');
                    document.getElementById(this.getAttribute('data-tab') + '-tab').classList.add('active');
                });
            });
            
            // Configurar filtros
            document.getElementById('deposit-action').addEventListener('change', function() {
                document.getElementById('reject-reason-container').style.display = 
                    this.value === 'reject' ? 'block' : 'none';
            });
            
            document.getElementById('withdrawal-action').addEventListener('change', function() {
                document.getElementById('withdrawal-reject-reason-container').style.display = 
                    this.value === 'reject' ? 'block' : 'none';
            });
            
            // Configurar búsquedas
            document.getElementById('deposit-search').addEventListener('input', filterDeposits);
            document.getElementById('deposit-filter').addEventListener('change', filterDeposits);
            
            document.getElementById('withdrawal-search').addEventListener('input', filterWithdrawals);
            document.getElementById('withdrawal-filter').addEventListener('change', filterWithdrawals);
            
            document.getElementById('user-search').addEventListener('input', filterUsers);
            
            // Configurar selector de tipo de animal
            document.querySelectorAll('.animal-type').forEach(type => {
                type.addEventListener('click', function() {
                    document.querySelectorAll('.animal-type').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedAnimalType = this.getAttribute('data-type');
                });
            });
            
            // Actualizar la hora cada segundo
            setInterval(updateLastUpdateTime, 1000);
        }
        
        // Cargar todos los datos
        function loadAllData() {
            loadUsers();
            loadDeposits();
            loadWithdrawals();
        }
        
        // Cargar usuarios
        function loadUsers() {
            db.collection('users').onSnapshot((snapshot) => {
                allUsers = [];
                let totalBalance = 0;
                
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    allUsers.push({
                        id: doc.id,
                        ...userData
                    });
                    
                    // Sumar al balance total
                    totalBalance += userData.balance || 0;
                });
                
                // Actualizar estadísticas
                document.getElementById('total-users').textContent = allUsers.length;
                document.getElementById('total-trx').textContent = totalBalance.toFixed(2);
                
                // Renderizar usuarios
                renderUsers(allUsers);
            });
        }
        
        // Cargar depósitos
        function loadDeposits() {
            // Los depósitos están almacenados en cada usuario
            db.collection('users').onSnapshot((snapshot) => {
                allDeposits = [];
                let pendingCount = 0;
                
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userId = doc.id;
                    const userEmail = userData.email;
                    
                    if (userData.pendingDeposits && userData.pendingDeposits.length > 0) {
                        userData.pendingDeposits.forEach(deposit => {
                            const depositData = {
                                userId: userId,
                                userEmail: userEmail,
                                ...deposit
                            };
                            
                            allDeposits.push(depositData);
                            
                            if (deposit.status === 'pending') {
                                pendingCount++;
                            }
                        });
                    }
                });
                
                // Actualizar estadísticas
                document.getElementById('pending-deposits').textContent = pendingCount;
                
                // Renderizar depósitos
                renderDeposits(allDeposits);
            });
        }
        
        // Cargar retiros
        function loadWithdrawals() {
            // Los retiros están en las transacciones de cada usuario
            db.collection('users').onSnapshot((snapshot) => {
                allWithdrawals = [];
                let pendingCount = 0;
                
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userId = doc.id;
                    const userEmail = userData.email;
                    
                    if (userData.transactions && userData.transactions.length > 0) {
                        userData.transactions.forEach(transaction => {
                            if (transaction.type === 'withdrawal') {
                                const withdrawalData = {
                                    userId: userId,
                                    userEmail: userEmail,
                                    ...transaction
                                };
                                
                                allWithdrawals.push(withdrawalData);
                                
                                // Asumimos que los retiros sin estado son pendientes
                                if (!transaction.status || transaction.status === 'pending') {
                                    pendingCount++;
                                }
                            }
                        });
                    }
                });
                
                // Actualizar estadísticas
                document.getElementById('pending-withdrawals').textContent = pendingCount;
                
                // Renderizar retiros
                renderWithdrawals(allWithdrawals);
            });
        }
        
        // Renderizar usuarios en la tabla
        function renderUsers(users) {
            const usersTable = document.getElementById('users-table');
            usersTable.innerHTML = '';
            
            if (users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay usuarios registrados</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                
                // Calcular número de animales
                const animalCount = user.animals ? user.animals.length : 0;
                
                // Calcular número de referidos
                const referralCount = user.referrals ? user.referrals.length : 0;
                
                // Formatear fecha de registro
                const registerDate = user.createdAt ? 
                    new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 
                    'N/A';
                
                tr.innerHTML = `
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.balance ? user.balance.toFixed(2) : '0.00'} TRX</td>
                    <td>${animalCount} <button class="btn btn-info btn-sm" onclick="viewAnimals('${user.id}')"><i class="fas fa-eye"></i></button></td>
                    <td>${referralCount} <button class="btn btn-info btn-sm" onclick="viewReferrals('${user.id}')"><i class="fas fa-eye"></i></button></td>
                    <td>${registerDate}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editUser('${user.id}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDeleteUser('${user.id}')">Eliminar</button>
                    </td>
                `;
                
                usersTable.appendChild(tr);
            });
        }
        
        // Renderizar depósitos en la tabla
        function renderDeposits(deposits) {
            const depositsTable = document.getElementById('deposits-table');
            depositsTable.innerHTML = '';
            
            if (deposits.length === 0) {
                depositsTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay depósitos registrados</td></tr>';
                return;
            }
            
            // Ordenar por fecha (más recientes primero)
            deposits.sort((a, b) => {
                const dateA = a.date ? a.date.seconds : 0;
                const dateB = b.date ? b.date.seconds : 0;
                return dateB - dateA;
            });
            
            deposits.forEach(deposit => {
                const tr = document.createElement('tr');
                
                // Formatear fecha
                const depositDate = deposit.date ? 
                    new Date(deposit.date.seconds * 1000).toLocaleDateString() : 
                    'N/A';
                
                // Estado
                let statusBadge = '';
                if (deposit.status === 'approved') {
                    statusBadge = '<span class="status-badge status-approved">Aprobado</span>';
                } else if (deposit.status === 'rejected') {
                    statusBadge = '<span class="status-badge status-rejected">Rechazado</span>';
                } else {
                    statusBadge = '<span class="status-badge status-pending">Pendiente</span>';
                }
                
                // Acciones
                let actions = '';
                if (deposit.status === 'pending') {
                    actions = `
                        <button class="btn btn-success btn-sm" onclick="openDepositModal('${deposit.userId}', '${deposit.txHash}')">Gestionar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDeposit('${deposit.userId}', '${deposit.txHash}')">Eliminar</button>
                    `;
                } else {
                    actions = `
                        <span class="status-badge">Procesado</span>
                        <button class="btn btn-danger btn-sm" onclick="deleteDeposit('${deposit.userId}', '${deposit.txHash}')">Eliminar</button>
                    `;
                }
                
                tr.innerHTML = `
                    <td>${deposit.userEmail || 'N/A'}</td>
                    <td>${deposit.amount ? deposit.amount.toFixed(2) : '0.00'} TRX</td>
                    <td title="${deposit.txHash || 'N/A'}">${deposit.txHash ? deposit.txHash.substring(0, 10) + '...' : 'N/A'}</td>
                    <td>${depositDate}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                `;
                
                depositsTable.appendChild(tr);
            });
        }
        
        // Renderizar retiros en la tabla
        function renderWithdrawals(withdrawals) {
            const withdrawalsTable = document.getElementById('withdrawals-table');
            withdrawalsTable.innerHTML = '';
            
            if (withdrawals.length === 0) {
                withdrawalsTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay retiros registrados</td></tr>';
                return;
            }
            
            // Ordenar por fecha (más recientes primero)
            withdrawals.sort((a, b) => {
                const dateA = a.date ? a.date.seconds : 0;
                const dateB = b.date ? b.date.seconds : 0;
                return dateB - dateA;
            });
            
            withdrawals.forEach(withdrawal => {
                const tr = document.createElement('tr');
                
                // Formatear fecha
                const withdrawalDate = withdrawal.date ? 
                    new Date(withdrawal.date.seconds * 1000).toLocaleDateString() : 
                    'N/A';
                
                // Extraer dirección TRX de los detalles
                let trxAddress = 'N/A';
                if (withdrawal.details && withdrawal.details.includes('dirección:')) {
                    trxAddress = withdrawal.details.split('dirección:')[1].trim();
                }
                
                // Estado
                let statusBadge = '';
                if (withdrawal.status === 'approved') {
                    statusBadge = '<span class="status-badge status-approved">Aprobado</span>';
                } else if (withdrawal.status === 'rejected') {
                    statusBadge = '<span class="status-badge status-rejected">Rechazado</span>';
                } else {
                    statusBadge = '<span class="status-badge status-pending">Pendiente</span>';
                }
                
                // Acciones
                let actions = '';
                if (!withdrawal.status || withdrawal.status === 'pending') {
                    actions = `
                        <button class="btn btn-success btn-sm" onclick="openWithdrawalModal('${withdrawal.userId}', '${withdrawal.amount}', '${withdrawalDate}')">Gestionar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteWithdrawal('${withdrawal.userId}', '${withdrawal.amount}', '${withdrawalDate}')">Eliminar</button>
                    `;
                } else {
                    actions = `
                        <span class="status-badge">Procesado</span>
                        <button class="btn btn-danger btn-sm" onclick="deleteWithdrawal('${withdrawal.userId}', '${withdrawal.amount}', '${withdrawalDate}')">Eliminar</button>
                    `;
                }
                
                tr.innerHTML = `
                    <td>${withdrawal.userEmail || 'N/A'}</td>
                    <td>${withdrawal.amount ? withdrawal.amount.toFixed(2) : '0.00'} TRX</td>
                    <td title="${trxAddress}">${trxAddress.substring(0, 10) + '...'}</td>
                    <td>${withdrawalDate}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                `;
                
                withdrawalsTable.appendChild(tr);
            });
        }
        
        // Filtrar y mostrar animales de usuario
        function filterAnimals() {
            const searchTerm = document.getElementById('animal-search').value.toLowerCase();
            const animalsContainer = document.getElementById('animals-container');
            
            if (!searchTerm) {
                animalsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Ingresa el email de un usuario para buscar sus animales.
                    </div>
                `;
                return;
            }
            
            const user = allUsers.find(u => u.email && u.email.toLowerCase().includes(searchTerm));
            
            if (!user) {
                animalsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No se encontró ningún usuario con ese email.
                    </div>
                `;
                return;
            }
            
            const animalCount = user.animals ? user.animals.length : 0;
            
            animalsContainer.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Usuario encontrado: ${user.email}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: var(--secondary);">Animales de ${user.email}</h3>
                    <div>Total: ${animalCount} animales</div>
                </div>
            `;
            
            if (animalCount === 0) {
                animalsContainer.innerHTML += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Este usuario no tiene animales aún.
                    </div>
                    <button class="btn btn-success" onclick="viewAnimals('${user.id}')">
                        <i class="fas fa-plus"></i> Añadir Animales
                    </button>
                `;
                return;
            }
            
            const animalsGrid = document.createElement('div');
            animalsGrid.className = 'animals-grid';
            
            user.animals.forEach((animal, index) => {
                const animalCard = document.createElement('div');
                animalCard.className = 'animal-card';
                
                // Icono según el tipo de animal
                let animalIcon = 'fas fa-question';
                if (animal.type === 'vaca') animalIcon = 'fas fa-cow';
                if (animal.type === 'gallina') animalIcon = 'fas fa-kiwi-bird';
                if (animal.type === 'cerdo') animalIcon = 'fas fa-piggy-bank';
                if (animal.type === 'oveja') animalIcon = 'fas fa-cloud';
                if (animal.type === 'caballo') animalIcon = 'fas fa-horse';
                
                animalCard.innerHTML = `
                    <div class="animal-icon">
                        <i class="${animalIcon}"></i>
                    </div>
                    <div class="animal-name">${animal.type.charAt(0).toUpperCase() + animal.type.slice(1)}</div>
                    <div class="animal-level">Nivel ${animal.level || 1}</div>
                    <div class="animal-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteAnimal('${user.id}', ${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                animalsGrid.appendChild(animalCard);
            });
            
            animalsContainer.appendChild(animalsGrid);
            
            const manageButton = document.createElement('button');
            manageButton.className = 'btn btn-primary';
            manageButton.style.marginTop = '15px';
            manageButton.innerHTML = '<i class="fas fa-cog"></i> Gestionar Animales';
            manageButton.onclick = function() {
                viewAnimals(user.id);
            };
            
            animalsContainer.appendChild(manageButton);
        }
        
        // Abrir modal para gestionar animales
        function viewAnimals(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            currentAnimalUser = user;
            
            document.getElementById('modal-animals-user').value = user.email || 'N/A';
            document.getElementById('modal-animals-count').value = user.animals ? user.animals.length : 0;
            
            // Limpiar selección de tipo de animal
            document.querySelectorAll('.animal-type').forEach(t => t.classList.remove('selected'));
            selectedAnimalType = null;
            
            // Cargar lista de animales actuales
            const animalsList = document.getElementById('modal-animals-list');
            animalsList.innerHTML = '';
            
            if (user.animals && user.animals.length > 0) {
                user.animals.forEach((animal, index) => {
                    // Icono según el tipo de animal
                    let animalIcon = 'fas fa-question';
                    if (animal.type === 'vaca') animalIcon = 'fas fa-cow';
                    if (animal.type === 'gallina') animalIcon = 'fas fa-kiwi-bird';
                    if (animal.type === 'cerdo') animalIcon = 'fas fa-piggy-bank';
                    if (animal.type === 'oveja') animalIcon = 'fas fa-cloud';
                    if (animal.type === 'caballo') animalIcon = 'fas fa-horse';
                    
                    const animalCard = document.createElement('div');
                    animalCard.className = 'animal-card';
                    
                    animalCard.innerHTML = `
                        <div class="animal-icon">
                            <i class="${animalIcon}"></i>
                        </div>
                        <div class="animal-name">${animal.type.charAt(0).toUpperCase() + animal.type.slice(1)}</div>
                        <div class="animal-level">Nivel ${animal.level || 1}</div>
                        <div class="animal-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteAnimal('${user.id}', ${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    animalsList.appendChild(animalCard);
                });
            } else {
                animalsList.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px;">No hay animales</div>';
            }
            
            openModal('animals-modal');
        }
        
        // Añadir animal a usuario
        function addAnimal() {
            if (!currentAnimalUser) return;
            
            if (!selectedAnimalType) {
                showToast('Selecciona un tipo de animal', 'error');
                return;
            }
            
            const level = parseInt(document.getElementById('animal-level').value) || 1;
            
            const userRef = db.collection('users').doc(currentAnimalUser.id);
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    const newAnimal = {
                        type: selectedAnimalType,
                        level: level,
                        purchaseDate: new Date()
                    };
                    
                    if (!userData.animals) {
                        userData.animals = [];
                    }
                    
                    userData.animals.push(newAnimal);
                    
                    return userRef.update({
                        animals: userData.animals
                    });
                }
            }).then(() => {
                showToast('Animal añadido correctamente', 'success');
                
                // Actualizar la lista de animales en el modal
                if (currentAnimalUser.animals) {
                    currentAnimalUser.animals.push({
                        type: selectedAnimalType,
                        level: level
                    });
                } else {
                    currentAnimalUser.animals = [{
                        type: selectedAnimalType,
                        level: level
                    }];
                }
                
                document.getElementById('modal-animals-count').value = currentAnimalUser.animals.length;
                
                // Volver a renderizar la lista de animales
                viewAnimals(currentAnimalUser.id);
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error adding animal:', error);
                showToast('Error al añadir el animal', 'error');
            });
        }
        
        // Eliminar animal de usuario
        function deleteAnimal(userId, animalIndex) {
            if (!confirm('¿Estás seguro de que deseas eliminar este animal? Esta acción no se puede deshacer.')) {
                return;
            }
            
            const userRef = db.collection('users').doc(userId);
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    if (userData.animals && userData.animals.length > animalIndex) {
                        userData.animals.splice(animalIndex, 1);
                        
                        return userRef.update({
                            animals: userData.animals
                        });
                    }
                }
            }).then(() => {
                showToast('Animal eliminado correctamente', 'success');
                
                // Actualizar la lista de animales en el modal si estamos viendo este usuario
                if (currentAnimalUser && currentAnimalUser.id === userId) {
                    if (currentAnimalUser.animals && currentAnimalUser.animals.length > animalIndex) {
                        currentAnimalUser.animals.splice(animalIndex, 1);
                        document.getElementById('modal-animals-count').value = currentAnimalUser.animals.length;
                        viewAnimals(userId);
                    }
                }
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error deleting animal:', error);
                showToast('Error al eliminar el animal', 'error');
            });
        }
        
        // Abrir modal para gestionar depósito
        function openDepositModal(userId, txHash) {
            // Buscar el depósito en la lista
            const deposit = allDeposits.find(d => d.userId === userId && d.txHash === txHash);
            if (!deposit) return;
            
            currentEditingDeposit = deposit;
            
            document.getElementById('modal-deposit-user').value = deposit.userEmail || 'N/A';
            document.getElementById('modal-deposit-amount').value = deposit.amount ? deposit.amount.toFixed(2) + ' TRX' : '0.00 TRX';
            document.getElementById('modal-deposit-hash').value = deposit.txHash || 'N/A';
            document.getElementById('modal-deposit-date').value = deposit.date ? 
                new Date(deposit.date.seconds * 1000).toLocaleString() : 'N/A';
            document.getElementById('modal-deposit-status').value = deposit.status || 'pending';
            
            // Resetear formulario
            document.getElementById('deposit-action').value = 'approve';
            document.getElementById('reject-reason-container').style.display = 'none';
            document.getElementById('reject-reason').value = '';
            
            openModal('deposit-modal');
        }
        
        // Abrir modal para gestionar retiro
        function openWithdrawalModal(userId, amount, date) {
            // Buscar el retiro en la lista
            const withdrawal = allWithdrawals.find(w => 
                w.userId === userId && 
                w.amount === parseFloat(amount) && 
                w.date && 
                new Date(w.date.seconds * 1000).toLocaleDateString() === date
            );
            
            if (!withdrawal) return;
            
            currentEditingWithdrawal = withdrawal;
            
            document.getElementById('modal-withdrawal-user').value = withdrawal.userEmail || 'N/A';
            document.getElementById('modal-withdrawal-amount').value = withdrawal.amount ? withdrawal.amount.toFixed(2) + ' TRX' : '0.00 TRX';
            
            // Extraer dirección TRX de los detalles
            let trxAddress = 'N/A';
            if (withdrawal.details && withdrawal.details.includes('dirección:')) {
                trxAddress = withdrawal.details.split('dirección:')[1].trim();
            }
            document.getElementById('modal-withdrawal-address').value = trxAddress;
            
            document.getElementById('modal-withdrawal-date').value = withdrawal.date ? 
                new Date(withdrawal.date.seconds * 1000).toLocaleString() : 'N/A';
            document.getElementById('modal-withdrawal-status').value = withdrawal.status || 'pending';
            
            // Resetear formulario
            document.getElementById('withdrawal-action').value = 'approve';
            document.getElementById('withdrawal-reject-reason-container').style.display = 'none';
            document.getElementById('withdrawal-reject-reason').value = '';
            
            openModal('withdrawal-modal');
        }
        
        // Abrir modal para editar usuario
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            currentEditingUser = user;
            
            document.getElementById('modal-user-id').value = user.id;
            document.getElementById('modal-user-email').value = user.email || 'N/A';
            document.getElementById('modal-user-balance').value = user.balance || 0;
            document.getElementById('modal-user-status').value = user.accountStatus || 'active';
            
            openModal('user-modal');
        }
        
        // Abrir modal para ver referidos
        function viewReferrals(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('modal-referrals-user').value = user.email || 'N/A';
            document.getElementById('modal-referrals-count').value = user.referrals ? user.referrals.length : 0;
            
            const referralsList = document.getElementById('referrals-list');
            referralsList.innerHTML = '';
            
            if (user.referrals && user.referrals.length > 0) {
                user.referrals.forEach((referral, index) => {
                    // Asegurarse de que referral es una cadena de texto (email)
                    const referralEmail = typeof referral === 'object' ? referral.email || 'Correo no disponible' : referral;
                    
                    const referralItem = document.createElement('div');
                    referralItem.className = 'referral-item';
                    referralItem.textContent = `${index + 1}. ${referralEmail}`;
                    referralsList.appendChild(referralItem);
                });
            } else {
                referralsList.innerHTML = '<div class="referral-item">No hay referidos</div>';
            }
            
            openModal('referrals-modal');
        }
        
        // Procesar depósito (aprobar/rechazar/eliminar)
        function processDeposit() {
            if (!currentEditingDeposit) return;
            
            const action = document.getElementById('deposit-action').value;
            const rejectReason = document.getElementById('reject-reason').value;
            const processBtn = document.getElementById('process-deposit-btn');
            
            // Mostrar indicador de carga
            processBtn.innerHTML = '<div class="loading"></div> Procesando...';
            processBtn.disabled = true;
            
            // Obtener referencia al usuario
            const userRef = db.collection('users').doc(currentEditingDeposit.userId);
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    // Encontrar el depósito en el array de pendingDeposits
                    const depositIndex = userData.pendingDeposits.findIndex(
                        d => d.txHash === currentEditingDeposit.txHash
                    );
                    
                    if (depositIndex !== -1) {
                        if (action === 'delete') {
                            // Eliminar el depósito
                            userData.pendingDeposits.splice(depositIndex, 1);
                        } else if (action === 'approve') {
                            // Actualizar el estado del depósito
                            userData.pendingDeposits[depositIndex].status = 'approved';
                            
                            // Añadir al balance del usuario
                            const depositAmount = currentEditingDeposit.amount || 0;
                            userData.balance = (userData.balance || 0) + depositAmount;
                            
                            // Crear transacción de depósito
                            const depositTransaction = {
                                type: 'deposit',
                                amount: depositAmount,
                                date: currentEditingDeposit.date,
                                status: 'completed',
                                details: `Depósito aprobado - Hash: ${currentEditingDeposit.txHash}`
                            };
                            
                            if (!userData.transactions) {
                                userData.transactions = [];
                            }
                            userData.transactions.push(depositTransaction);
                        } else {
                            // Rechazar el depósito
                            userData.pendingDeposits[depositIndex].status = 'rejected';
                            userData.pendingDeposits[depositIndex].rejectReason = rejectReason;
                        }
                        
                        // Actualizar en Firestore
                        return userRef.update({
                            balance: userData.balance,
                            pendingDeposits: userData.pendingDeposits,
                            transactions: userData.transactions
                        });
                    }
                }
            }).then(() => {
                // Mostrar mensaje de éxito
                let message = '';
                if (action === 'approve') {
                    message = 'Depósito aprobado correctamente';
                } else if (action === 'reject') {
                    message = 'Depósito rechazado correctamente';
                } else {
                    message = 'Depósito eliminado correctamente';
                }
                
                showToast(message, 'success');
                
                // Cerrar modal y recargar datos
                closeModal('deposit-modal');
                currentEditingDeposit = null;
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error updating deposit:', error);
                showToast('Error al procesar el depósito', 'error');
            }).finally(() => {
                // Restaurar botón
                processBtn.innerHTML = 'Procesar';
                processBtn.disabled = false;
            });
        }
        
        // Procesar retiro (aprobar/rechazar/eliminar)
        function processWithdrawal() {
            if (!currentEditingWithdrawal) return;
            
            const action = document.getElementById('withdrawal-action').value;
            const rejectReason = document.getElementById('withdrawal-reject-reason').value;
            const processBtn = document.getElementById('process-withdrawal-btn');
            
            // Mostrar indicador de carga
            processBtn.innerHTML = '<div class="loading"></div> Procesando...';
            processBtn.disabled = true;
            
            // Obtener referencia al usuario
            const userRef = db.collection('users').doc(currentEditingWithdrawal.userId);
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    // Encontrar el retiro en el array de transactions
                    const transactionIndex = userData.transactions.findIndex(
                        t => t.type === 'withdrawal' && 
                             t.amount === currentEditingWithdrawal.amount && 
                             t.date.seconds === currentEditingWithdrawal.date.seconds
                    );
                    
                    if (transactionIndex !== -1) {
                        if (action === 'delete') {
                            // Eliminar el retiro
                            userData.transactions.splice(transactionIndex, 1);
                        } else if (action === 'approve') {
                            // Actualizar el estado del retiro
                            userData.transactions[transactionIndex].status = 'approved';
                        } else {
                            // Rechazar el retiro
                            userData.transactions[transactionIndex].status = 'rejected';
                            userData.transactions[transactionIndex].rejectReason = rejectReason;
                            
                            // Devolver el dinero al balance del usuario
                            const withdrawalAmount = currentEditingWithdrawal.amount || 0;
                            userData.balance = (userData.balance || 0) + withdrawalAmount;
                        }
                        
                        // Actualizar en Firestore
                        return userRef.update({
                            balance: userData.balance,
                            transactions: userData.transactions
                        });
                    }
                }
            }).then(() => {
                // Mostrar mensaje de éxito
                let message = '';
                if (action === 'approve') {
                    message = 'Retiro aprobado correctamente';
                } else if (action === 'reject') {
                    message = 'Retiro rechazado correctamente';
                } else {
                    message = 'Retiro eliminado correctamente';
                }
                
                showToast(message, 'success');
                
                // Cerrar modal y recargar datos
                closeModal('withdrawal-modal');
                currentEditingWithdrawal = null;
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error updating withdrawal:', error);
                showToast('Error al procesar el retiro', 'error');
            }).finally(() => {
                // Restaurar botón
                processBtn.innerHTML = 'Procesar';
                processBtn.disabled = false;
            });
        }
        
        // Eliminar depósito directamente
        function deleteDeposit(userId, txHash) {
            if (!confirm('¿Estás seguro de que deseas eliminar este depósito? Esta acción no se puede deshacer.')) {
                return;
            }
            
            // Obtener referencia al usuario
            const userRef = db.collection('users').doc(userId);
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    // Encontrar el depósito en el array de pendingDeposits
                    const depositIndex = userData.pendingDeposits.findIndex(
                        d => d.txHash === txHash
                    );
                    
                    if (depositIndex !== -1) {
                        // Eliminar el depósito
                        userData.pendingDeposits.splice(depositIndex, 1);
                        
                        // Actualizar en Firestore
                        return userRef.update({
                            pendingDeposits: userData.pendingDeposits
                        });
                    }
                }
            }).then(() => {
                showToast('Depósito eliminado correctamente', 'success');
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error deleting deposit:', error);
                showToast('Error al eliminar el depósito', 'error');
            });
        }
        
        // Eliminar retiro directamente
        function deleteWithdrawal(userId, amount, date) {
            if (!confirm('¿Estás seguro de que deseas eliminar este retiro? Esta acción no se puede deshacer.')) {
                return;
            }
            
            // Buscar el retiro en la lista
            const withdrawal = allWithdrawals.find(w => 
                w.userId === userId && 
                w.amount === parseFloat(amount) && 
                w.date && 
                new Date(w.date.seconds * 1000).toLocaleDateString() === date
            );
            
            if (!withdrawal) return;
            
            // Obtener referencia al usuario
            const userRef = db.collection('users').doc(userId);
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    // Encontrar el retiro en el array de transactions
                    const transactionIndex = userData.transactions.findIndex(
                        t => t.type === 'withdrawal' && 
                             t.amount === withdrawal.amount && 
                             t.date.seconds === withdrawal.date.seconds
                    );
                    
                    if (transactionIndex !== -1) {
                        // Eliminar el retiro
                        userData.transactions.splice(transactionIndex, 1);
                        
                        // Actualizar en Firestore
                        return userRef.update({
                            transactions: userData.transactions
                        });
                    }
                }
            }).then(() => {
                showToast('Retiro eliminado correctamente', 'success');
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error deleting withdrawal:', error);
                showToast('Error al eliminar el retiro', 'error');
            });
        }
        
        // Confirmar eliminación de usuario
        function confirmDeleteUser(userId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer y se eliminarán todos sus datos.')) {
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            currentEditingUser = user;
            deleteUser();
        }
        
        // Eliminar usuario
        function deleteUser() {
            if (!currentEditingUser) return;
            
            const userRef = db.collection('users').doc(currentEditingUser.id);
            
            userRef.delete().then(() => {
                showToast('Usuario eliminado correctamente', 'success');
                closeModal('user-modal');
                currentEditingUser = null;
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error deleting user:', error);
                showToast('Error al eliminar el usuario', 'error');
            });
        }
        
        // Actualizar usuario
        function updateUser() {
            if (!currentEditingUser) return;
            
            const newBalance = parseFloat(document.getElementById('modal-user-balance').value);
            const accountStatus = document.getElementById('modal-user-status').value;
            const updateBtn = document.getElementById('update-user-btn');
            
            // Mostrar indicador de carga
            updateBtn.innerHTML = '<div class="loading"></div> Actualizando...';
            updateBtn.disabled = true;
            
            // Obtener referencia al usuario
            const userRef = db.collection('users').doc(currentEditingUser.id);
            
            userRef.update({
                balance: newBalance,
                accountStatus: accountStatus
            }).then(() => {
                showToast('Usuario actualizado correctamente', 'success');
                closeModal('user-modal');
                currentEditingUser = null;
                
                // Recargar datos después de un breve retraso
                setTimeout(() => {
                    loadAllData();
                }, 1000);
            }).catch((error) => {
                console.error('Error updating user:', error);
                showToast('Error al actualizar el usuario', 'error');
            }).finally(() => {
                // Restaurar botón
                updateBtn.innerHTML = 'Actualizar';
                updateBtn.disabled = false;
            });
        }
        
        // Filtrar depósitos
        function filterDeposits() {
            const searchTerm = document.getElementById('deposit-search').value.toLowerCase();
            const filterValue = document.getElementById('deposit-filter').value;
            
            let filteredDeposits = allDeposits;
            
            // Aplicar filtro de estado
            if (filterValue !== 'all') {
                filteredDeposits = filteredDeposits.filter(deposit => 
                    deposit.status === filterValue
                );
            }
            
            // Aplicar filtro de búsqueda
            if (searchTerm) {
                filteredDeposits = filteredDeposits.filter(deposit => 
                    (deposit.userEmail && deposit.userEmail.toLowerCase().includes(searchTerm)) ||
                    (deposit.txHash && deposit.txHash.toLowerCase().includes(searchTerm)) ||
                    (deposit.userId && deposit.userId.toLowerCase().includes(searchTerm))
                );
            }
            
            renderDeposits(filteredDeposits);
        }
        
        // Filtrar retiros
        function filterWithdrawals() {
            const searchTerm = document.getElementById('withdrawal-search').value.toLowerCase();
            const filterValue = document.getElementById('withdrawal-filter').value;
            
            let filteredWithdrawals = allWithdrawals;
            
            // Aplicar filtro de estado
            if (filterValue !== 'all') {
                filteredWithdrawals = filteredWithdrawals.filter(withdrawal => 
                    withdrawal.status === filterValue
                );
            }
            
            // Aplicar filtro de búsqueda
            if (searchTerm) {
                filteredWithdrawals = filteredWithdrawals.filter(withdrawal => 
                    (withdrawal.userEmail && withdrawal.userEmail.toLowerCase().includes(searchTerm)) ||
                    (withdrawal.details && withdrawal.details.toLowerCase().includes(searchTerm)) ||
                    (withdrawal.userId && withdrawal.userId.toLowerCase().includes(searchTerm))
                );
            }
            
            renderWithdrawals(filteredWithdrawals);
        }
        
        // Filtrar usuarios
        function filterUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            
            const filteredUsers = allUsers.filter(user => 
                (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                (user.id && user.id.toLowerCase().includes(searchTerm))
            );
            
            renderUsers(filteredUsers);
        }
        
        // Abrir modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Mostrar notificación toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = toast.querySelector('i');
            
            // Configurar según el tipo
            toast.className = 'toast';
            toast.classList.add(type);
            
            // Cambiar icono según el tipo
            if (type === 'success') {
                toastIcon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toastIcon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toastIcon.className = 'fas fa-exclamation-triangle';
            } else if (type === 'info') {
                toastIcon.className = 'fas fa-info-circle';
            }
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Actualizar la hora de última actualización
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                `Última actualización: ${now.toLocaleTimeString()}`;
        }
        
        // Inicializar la aplicación cuando se carga la página
        window.onload = initApp;
    </script>
</body>
</html>
